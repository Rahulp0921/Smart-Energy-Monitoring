<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Energy Monitoring Dashboard</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- DataLabels Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    :root{--bg:#ffffff;--surface:#ffffff;--muted:#475569;--border:#e6edf3;--text:#0f172a}
    .dark{--bg:#0b1220;--surface:#0f172a;--muted:#94a3b8;--border:#1f2937;--text:#e6eef8}
    body{
      background:var(--bg);
      color:var(--text);
      transition:.25s ease;
      font-family:Inter,system-ui;
    }
    .surface{background:var(--surface);transition:.25s ease}
  </style>
</head>

<body class="antialiased">

  <div id="root" class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto">

    <header class="mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-2xl sm:text-3xl font-semibold">Smart Energy Monitoring Dashboard</h1>
        <p class="text-slate-500 dark:text-slate-400">Predicting demand & optimizing consumption.</p>
      </div>

      <!-- Theme Toggle -->
      <div class="flex items-center space-x-3">
        <span class="text-xs">Theme</span>
        <label class="relative inline-flex cursor-pointer">
          <input id="themeToggle" type="checkbox" class="sr-only">
          <div class="w-12 h-6 bg-slate-300 dark:bg-slate-700 rounded-full"></div>
          <div id="toggleKnob" class="absolute left-0.5 top-0.5 w-5 h-5 bg-white dark:bg-slate-800 rounded-full shadow transition-transform"></div>
        </label>
      </div>
    </header>

    <!-- KPI Cards -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">

      <div class="surface border rounded-lg p-4 shadow-sm">
        <div class="flex items-center">
          <div class="bg-slate-100 dark:bg-slate-700 p-3 rounded-full mr-4">
            âš¡
          </div>
          <div>
            <div class="text-sm text-slate-500 dark:text-slate-400">Current Consumption</div>
            <div class="text-2xl font-bold">
              <span id="kpi-current">...</span> <span class="text-sm">kW</span>
            </div>
          </div>
        </div>
      </div>

      <div class="surface border rounded-lg p-4 shadow-sm">
        <div class="flex items-center">
          <div class="bg-slate-100 dark:bg-slate-700 p-3 rounded-full mr-4">ðŸ“Š</div>
          <div>
            <div class="text-sm text-slate-500 dark:text-slate-400">24h Avg Consumption</div>
            <div class="text-2xl font-bold">
              <span id="kpi-avg">...</span> <span class="text-sm">kW</span>
            </div>
          </div>
        </div>
      </div>

      <div class="surface border rounded-lg p-4 shadow-sm">
        <div class="flex items-center">
          <div class="bg-slate-100 dark:bg-slate-700 p-3 rounded-full mr-4">ðŸ“ˆ</div>
          <div>
            <div class="text-sm text-slate-500 dark:text-slate-400">24h Peak Consumption</div>
            <div class="text-2xl font-bold">
              <span id="kpi-peak">...</span> <span class="text-sm">kW</span>
            </div>
          </div>
        </div>
      </div>

    </section>

    <!-- Charts -->
    <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- Line Forecast Chart -->
      <section class="surface border rounded-lg p-6 shadow-lg">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-medium">Consumption Forecast</h2>
          <div class="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-md">
            <button id="btn-Zone1" class="px-3 py-1 bg-cyan-600 text-white rounded-md">Zone 1</button>
            <button id="btn-Zone2" class="px-3 py-1 rounded-md">Zone 2</button>
            <button id="btn-Zone3" class="px-3 py-1 rounded-md">Zone 3</button>
          </div>
        </div>
        <div style="height:420px;">
          <canvas id="energyChart"></canvas>
        </div>
      </section>

      <!-- Right Column Charts -->
      <section class="space-y-6">

        <!-- Pie Chart -->
        <div class="surface border rounded-lg p-6 shadow-lg">
          <h3 class="font-medium mb-3">Total Consumption by Zone</h3>
          <div style="height:260px;">
            <canvas id="zonePieChart"></canvas>
          </div>
        </div>

        <!-- Bar Chart -->
        <div class="surface border rounded-lg p-6 shadow-lg">
          <h3 class="font-medium mb-3">Avg. Consumption by Hour</h3>
          <div style="height:260px;">
            <canvas id="hourlyBarChart"></canvas>
          </div>
        </div>

      </section>
    </main>

    <!-- Manual Data Form -->
    <section class="surface border rounded-lg p-6 shadow-lg mt-6">
      <h2 class="text-lg font-medium mb-4">Add Manual Data & Predict</h2>

      <form id="manualDataForm" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
        <div>
          <label>Date & Time</label>
          <input id="manualDate" type="datetime-local" required class="mt-1 w-full bg-slate-100 dark:bg-slate-700 border rounded-md py-2 px-3" />
        </div>

        <div>
          <label>Consumption (kW)</label>
          <input id="manualConsumption" type="number" required class="mt-1 w-full bg-slate-100 dark:bg-slate-700 border rounded-md py-2 px-3" />
        </div>

        <div>
          <label>Temperature (Â°C)</label>
          <input id="manualTemp" type="number" step="0.1" required class="mt-1 w-full bg-slate-100 dark:bg-slate-700 border rounded-md py-2 px-3" />
        </div>

        <div class="md:col-span-2 grid gap-2">
          <button class="w-full bg-cyan-600 hover:bg-cyan-700 text-white py-2 px-4 rounded-md">Add & Predict</button>
          <button type="button" id="resetDataBtn" class="w-full bg-slate-200 dark:bg-slate-600 py-2 px-4 rounded-md">Reset Data</button>
        </div>
      </form>

      <div class="mt-4 flex items-center">
        <input id="forceAlert" type="checkbox" class="h-4 w-4" />
        <label class="ml-2 text-sm">Force Show Alert</label>
      </div>
    </section>

    <div id="alert-container" class="mt-6"></div>

    <footer class="text-center text-sm mt-8 text-slate-500 dark:text-slate-400">
      Smart Energy Monitoring System | Demo
    </footer>

  </div>

<script>
/* -------------------------------------------
   INITIAL DATA
-------------------------------------------- */
const initialEnergyData = Object.freeze([
  {"DateTime":"2017-01-15 00:00","Temperature":7.8,"Zone1":32050,"Zone2":18030,"Zone3":19520},
  {"DateTime":"2017-01-15 01:00","Temperature":7.6,"Zone1":31080,"Zone2":17540,"Zone3":18910},
  {"DateTime":"2017-01-15 02:00","Temperature":7.5,"Zone1":30120,"Zone2":17110,"Zone3":18450},
  {"DateTime":"2017-01-15 03:00","Temperature":7.3,"Zone1":29540,"Zone2":16820,"Zone3":18110},
  {"DateTime":"2017-01-15 04:00","Temperature":7.2,"Zone1":29880,"Zone2":16950,"Zone3":18240},
  {"DateTime":"2017-01-15 05:00","Temperature":7.1,"Zone1":30950,"Zone2":17450,"Zone3":18760},
  {"DateTime":"2017-01-15 06:00","Temperature":7.0,"Zone1":33500,"Zone2":18890,"Zone3":20310},
  {"DateTime":"2017-01-15 07:00","Temperature":7.0,"Zone1":36800,"Zone2":20750,"Zone3":22310},
  {"DateTime":"2017-01-15 08:00","Temperature":7.2,"Zone1":38900,"Zone2":21950,"Zone3":23600},
  {"DateTime":"2017-01-15 09:00","Temperature":7.8,"Zone1":40150,"Zone2":22650,"Zone3":24350},
  {"DateTime":"2017-01-15 10:00","Temperature":8.5,"Zone1":40800,"Zone2":23000,"Zone3":24730},
  {"DateTime":"2017-01-15 11:00","Temperature":9.2,"Zone1":41100,"Zone2":23180,"Zone3":24920},
  {"DateTime":"2017-01-15 12:00","Temperature":9.8,"Zone1":40500,"Zone2":22850,"Zone3":24570},
  {"DateTime":"2017-01-15 13:00","Temperature":10.1,"Zone1":39800,"Zone2":22450,"Zone3":24140},
  {"DateTime":"2017-01-15 14:00","Temperature":10.2,"Zone1":38900,"Zone2":21950,"Zone3":23600},
  {"DateTime":"2017-01-15 15:00","Temperature":9.9,"Zone1":38200,"Zone2":21550,"Zone3":23170},
  {"DateTime":"2017-01-15 16:00","Temperature":9.5,"Zone1":39500,"Zone2":22280,"Zone3":23950},
  {"DateTime":"2017-01-15 17:00","Temperature":9.1,"Zone1":42300,"Zone2":23850,"Zone3":25640},
  {"DateTime":"2017-01-15 18:00","Temperature":8.8,"Zone1":44500,"Zone2":25100,"Zone3":26980},
  {"DateTime":"2017-01-15 19:00","Temperature":8.6,"Zone1":43800,"Zone2":24700,"Zone3":26550},
  {"DateTime":"2017-01-15 20:00","Temperature":8.4,"Zone1":42100,"Zone2":23750,"Zone3":25530},
  {"DateTime":"2017-01-15 21:00","Temperature":8.2,"Zone1":40200,"Zone2":22680,"Zone3":24380},
  {"DateTime":"2017-01-15 22:00","Temperature":8.1,"Zone1":38100,"Zone2":21490,"Zone3":23000},
  {"DateTime":"2017-01-15 23:00","Temperature":8.0,"Zone1":35500,"Zone2":20020,"Zone3":21520}
]);

let energyData = [...initialEnergyData];
let currentZone = "Zone1";

let myChart = null;
let zonePieChart = null;
let hourlyBarChart = null;

function formatTime(str){
  const d = new Date(str);
  return d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
}

function isDark(){
  return document.documentElement.classList.contains("dark");
}

function chartColors(){
  return isDark() ? {
    axis: "#94a3b8",
    grid: "#1f2937",
    tooltipBg: "#0f172a",
    tooltipBorder: "#334155",
    dataset1: "#22d3ee",
    dataset2: "#fb7185",
    pieBorder: "#0b1220"
  } : {
    axis: "#475569",
    grid: "#e6edf3",
    tooltipBg: "#ffffff",
    tooltipBorder: "#cbd5e1",
    dataset1: "#0ea5a4",
    dataset2: "#ef4444",
    pieBorder: "#ffffff"
  }
}

/* PIE CHART WITH PERCENT + kW */
function renderZonePie(data){
  const cols = chartColors();

  const totals = {
    "Zone 1": data.reduce((s,i)=>s+i.Zone1,0),
    "Zone 2": data.reduce((s,i)=>s+i.Zone2,0),
    "Zone 3": data.reduce((s,i)=>s+i.Zone3,0)
  };

  const totalSum = Object.values(totals).reduce((a,b)=>a+b,0);

  const cfg = {
    type:"pie",
    data:{
      labels:Object.keys(totals),
      datasets:[{
        data:Object.values(totals),
        backgroundColor:["#22d3ee","#fb7185","#4ade80"],
        borderColor:cols.pieBorder,
        borderWidth:2
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{ labels:{ color:cols.axis }},
        datalabels:{
          color:cols.axis,
          font:{ weight:"bold", size:13 },
          formatter:(value)=>{
            const pct = (value / totalSum) * 100;
            const kw = (value / 1000).toFixed(1);
            return `${pct.toFixed(1)}% (${kw}kW)`;
          }
        }
      }
    },
    plugins:[ChartDataLabels]
  };

  if(zonePieChart) zonePieChart.destroy();
  zonePieChart = new Chart(document.getElementById("zonePieChart"), cfg);
}

/* HOURLY BAR CHART */
function renderHourlyBar(zone,data){
  const cols = chartColors();

  const hourly = Array.from({length:24}, ()=>({sum:0,count:0}));
  data.forEach(it=>{
    const h = new Date(it.DateTime).getHours();
    hourly[h].sum += it[zone];
    hourly[h].count++;
  });

  const avg = hourly.map(h=> h.count ? h.sum/h.count : 0);
  const total = avg.reduce((s,v)=>s+v,0);

  const cfg = {
    type:"bar",
    data:{
      labels:Array.from({length:24},(_,i)=>i+":00"),
      datasets:[{
        data:avg,
        backgroundColor:"rgba(34,211,238,0.6)",
        borderColor:"#22d3ee",
        borderWidth:1
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        tooltip:{
          backgroundColor:cols.tooltipBg,
          bodyColor:cols.axis,
          titleColor:cols.axis,
          callbacks:{
            label:ctx=>{
              const v=ctx.parsed.y;
              const pct = total?((v/total)*100).toFixed(1):0;
              return `${(v/1000).toFixed(1)}k kW (${pct}%)`;
            }
          }
        }
      },
      scales:{
        x:{ ticks:{ color:cols.axis }, grid:{ color:cols.grid }},
        y:{ ticks:{ color:cols.axis, callback:v=>(v/1000).toFixed(0)+"k" }, grid:{ color:cols.grid }}
      }
    }
  };

  if(hourlyBarChart) hourlyBarChart.destroy();
  hourlyBarChart = new Chart(document.getElementById("hourlyBarChart"), cfg);
}

/* FORECAST MODEL */
function generateForecast(data,zoneKey,hours){
  if(data.length < 7) return [];
  const out = [];
  const last = data[data.length-1];
  const lastVal = last[zoneKey];
  const lastTemp = last.Temperature;

  const avg = data.slice(-6).reduce((s,i)=>s+i[zoneKey],0)/6;
  const trend = (avg - data[data.length-7][zoneKey]) / 6;

  const TEMP_SENS=0.02, BASE_TEMP=15;

  for(let i=1;i<=hours;i++){
    const next = new Date(new Date(last.DateTime).getTime() + i*3600000);
    const hour = next.getHours();

    let val = lastVal + trend*i;
    val *= Math.sin((hour-6)*Math.PI/12)*0.05 + 0.98;

    const tempDiff = Math.abs(lastTemp - BASE_TEMP);
    val *= (1 + tempDiff*TEMP_SENS);

    out.push({
      DateTime: next.toISOString().slice(0,16).replace("T"," "),
      Forecast: Math.max(0,val)
    });
  }

  return out;
}

/* MAIN LINE CHART */
function renderMainChart(zone,data,forecast){
  const cols = chartColors();

  const labels = data.map(d=>formatTime(d.DateTime))
                    .concat(forecast.map(f=>formatTime(f.DateTime)));

  const actual = data.map(d=>d[zone]).concat(new Array(forecast.length).fill(null));
  const fcast = new Array(data.length).fill(null).concat(forecast.map(f=>f.Forecast));

  const cfg = {
    type:"line",
    data:{
      labels,
      datasets:[
        {
          label:"Actual",
          data:actual,
          borderColor:cols.dataset1,
          backgroundColor:cols.dataset1+"22",
          fill:true,
          tension:0.3
        },
        {
          label:"Forecast",
          data:fcast,
          borderColor:cols.dataset2,
          backgroundColor:cols.dataset2+"22",
          fill:true,
          tension:0.3,
          borderDash:[6,4]
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{ labels:{ color:cols.axis }},
        tooltip:{
          backgroundColor:cols.tooltipBg,
          titleColor:cols.axis,
          bodyColor:cols.axis
        }
      },
      scales:{
        x:{ ticks:{ color:cols.axis }, grid:{ color:cols.grid }},
        y:{ ticks:{ color:cols.axis, callback:v=>(v/1000).toFixed(0)+"k" }, grid:{ color:cols.grid }}
      }
    }
  };

  if(myChart) myChart.destroy();
  myChart = new Chart(document.getElementById("energyChart"), cfg);
}

/* KPIs + ALERT */
function updateKPIs(zone,data){
  const cur = data[data.length-1][zone];
  const avg = data.reduce((s,i)=>s+i[zone],0)/data.length;
  const peak = Math.max(...data.map(i=>i[zone]));

  document.getElementById("kpi-current").textContent=(cur/1000).toFixed(1);
  document.getElementById("kpi-avg").textContent=(avg/1000).toFixed(1);
  document.getElementById("kpi-peak").textContent=(peak/1000).toFixed(1);

  return {peak};
}

function updateAlert(forecast, peak) {
  const box = document.getElementById("alert-container");
  const force = document.getElementById("forceAlert").checked;

  box.innerHTML = "";

  if (!forecast.length && !force) return;

  // Find max forecast
  let maxF = { Forecast: 0, DateTime: "" };
  if (forecast.length) {
    maxF = forecast.reduce((a, b) => a.Forecast > b.Forecast ? a : b);
  }

  // Determine which zone has highest current load
  const latest = energyData[energyData.length - 1];
  const zoneLoads = {
    Zone1: latest.Zone1,
    Zone2: latest.Zone2,
    Zone3: latest.Zone3
  };

  const zoneCausingPeak = Object.keys(zoneLoads)
    .reduce((a, b) => zoneLoads[a] > zoneLoads[b] ? a : b);

  // Show alert if forced OR actual breach
  if (force || maxF.Forecast > peak * 1.05) {
    box.innerHTML = `
      <div class="bg-yellow-100 dark:bg-yellow-900/40 p-4 rounded-md border border-yellow-400 dark:border-yellow-700">
        
        <div class="font-bold text-yellow-700 dark:text-yellow-300 text-lg">
          âš  High Demand Forecasted
        </div>

        <div class="text-sm text-yellow-800 dark:text-yellow-200 mt-1">
          <strong>Predicted Peak:</strong> ${(maxF.Forecast / 1000).toFixed(1)}k kW <br>
          <strong>Time:</strong> ${new Date(maxF.DateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} <br>
          <strong>Zone Responsible:</strong> ${zoneCausingPeak}
        </div>

        <hr class="my-3 border-yellow-300 dark:border-yellow-600">

        <div class="text-sm text-yellow-800 dark:text-yellow-200">
          <strong>Suggestions:</strong>
          <ul class="mt-1 ml-3">
            <li>â€¢ Reduce non-essential loads in ${zoneCausingPeak}</li>
            <li>â€¢ Shift heavy appliances to off-peak hours</li>
            <li>â€¢ Optimize HVAC and lighting usage</li>
            <li>â€¢ Enable smart load balancing</li>
          </ul>
        </div>
      </div>
    `;
  }
}

/* UPDATE EVERYTHING */
function updateAll(zone,data){
  const fc=generateForecast(data,zone,24);
  const k=updateKPIs(zone,data);
  updateAlert(fc,k.peak);
  renderMainChart(zone,data,fc);
  renderZonePie(data);
  renderHourlyBar(zone,data);
}

/* EVENTS + THEME */
const themeToggle = document.getElementById("themeToggle");
const toggleKnob = document.getElementById("toggleKnob");

function applyTheme(mode){
  if(mode === "dark"){
    document.documentElement.classList.add("dark");
    themeToggle.checked = true;
    toggleKnob.style.transform = "translateX(1.5rem)";
  } else {
    document.documentElement.classList.remove("dark");
    themeToggle.checked = false;
    toggleKnob.style.transform = "translateX(0)";
  }
  updateAll(currentZone, energyData);
}

const savedTheme = localStorage.getItem("theme");
if(savedTheme) applyTheme(savedTheme);
else if(window.matchMedia("(prefers-color-scheme: dark)").matches) applyTheme("dark");
else applyTheme("light");

themeToggle.addEventListener("change", ()=>{
  const mode = themeToggle.checked ? "dark" : "light";
  localStorage.setItem("theme", mode);
  applyTheme(mode);
});

/* ZONE SWITCHING */
function switchZone(zone){
  currentZone = zone;
  ["Zone1","Zone2","Zone3"].forEach(z=>{
    const btn = document.getElementById("btn-"+z);
    if(!btn) return;
    if(z === zone) btn.className = "px-3 py-1 bg-cyan-600 text-white rounded-md";
    else btn.className = "px-3 py-1 rounded-md";
  });
  updateAll(currentZone, energyData);
}

document.getElementById("btn-Zone1").addEventListener("click", ()=> switchZone("Zone1"));
document.getElementById("btn-Zone2").addEventListener("click", ()=> switchZone("Zone2"));
document.getElementById("btn-Zone3").addEventListener("click", ()=> switchZone("Zone3"));

/* MANUAL DATA FORM */
const manualForm = document.getElementById("manualDataForm");
const manualDateEl = document.getElementById("manualDate");
const manualConsEl = document.getElementById("manualConsumption");
const manualTempEl = document.getElementById("manualTemp");
const resetBtn = document.getElementById("resetDataBtn");
const forceAlertEl = document.getElementById("forceAlert");

manualForm.addEventListener("submit", function(e){
  e.preventDefault();

  const dateVal = manualDateEl.value;
  const cons = parseFloat(manualConsEl.value);
  const temp = parseFloat(manualTempEl.value);

  const last = energyData[energyData.length-1];

  const newPoint = {
    DateTime: dateVal.replace("T"," "),
    Temperature: temp,
    Zone1: last.Zone1,
    Zone2: last.Zone2,
    Zone3: last.Zone3
  };
  newPoint[currentZone] = cons;

  energyData.push(newPoint);
  energyData.sort((a,b)=> new Date(a.DateTime) - new Date(b.DateTime));

  updateAll(currentZone, energyData);

  manualForm.reset();
});

/* RESET DATA */
resetBtn.addEventListener("click", ()=>{
  energyData = [...initialEnergyData];
  updateAll(currentZone, energyData);
});

/* FORCE ALERT */
forceAlertEl.addEventListener("change", ()=> updateAll(currentZone, energyData));

/* INITIALIZATION */
window.addEventListener("load", ()=>{
  const last = new Date(energyData[energyData.length-1].DateTime);
  last.setHours(last.getHours()+1);
  manualDateEl.value = last.toISOString().slice(0,16);

  switchZone(currentZone);
  updateAll(currentZone, energyData);
});
</script>

</body>
</html>
